module Test where 

import Daml.Script
import Inventory
import DA.Optional (fromSome)
-- import Setup

testWorkFlow : Script ()
testWorkFlow = script do
  manufacturer <- allocateParty "Manufacturer"
  ultaSupplier <- allocateParty "UltaSupplier"
  sephoraSupplier <- allocateParty "SephoraSupplier"
  customer <- allocateParty "Customer"

  ultaProd1 <- submit ultaSupplier do
    createCmd Inventory.Product with
      -- manufacturer = manufacturer
      supplier = ultaSupplier
      productId = "UltaP123"
      productName = "Ulta Mascara"
      quantity = 50
      price = 100.0

  sephoraProd1 <- submit sephoraSupplier do
    createCmd Product with
      -- manufacturer = manufacturer
      supplier = sephoraSupplier
      productId = "SephoraP456"
      productName = "Sephora Lip Kit"
      quantity = 30
      price = 150.0

  maybeNewUltaProd1 <- submit ultaSupplier do 
    exerciseCmd ultaProd1 UpdatePrice with newPrice = 75.0
  let newUltaProd1 = fromSome maybeNewUltaProd1

  _ <- submitMulti [manufacturer, ultaSupplier][ultaSupplier] do 
    exerciseCmd newUltaProd1 UpdateStock with stockChange = 75

  oid1 <- submit customer do
    createCmd Order with
      customer
      supplier = ultaSupplier
      orderId = "Order001"
      productsOrdered = [("UltaP123", 2)]

  -- _ <- submit ultaSupplier do
  --   exerciseCmd oid1 AcceptOrder

  oid2 <- submit customer do
    createCmd Order with
      customer
      supplier = sephoraSupplier
      orderId = "Order002"
      productsOrdered = [("SephoraP456", 1)]

  -- _ <- submit sephoraSupplier do
  --   exerciseCmd oid2 AcceptOrder

  oid3 <- submit customer do
    createCmd Order with
      customer
      supplier = sephoraSupplier
      orderId = "Order003"
      productsOrdered = [("SephoraP456", 1)]

  _ <- submit customer do 
    exerciseCmd oid3 CancelOrder

  submitMustFail customer do
    exerciseCmd oid1 AcceptOrder

  submitMustFail manufacturer do
    exerciseCmd oid1 AcceptOrder

  submitMustFail customer do
    createCmd Order with
      customer
      supplier = ultaSupplier
      orderId = "InvalidOrder"
      productsOrdered = [("UltaP123", -1)]

  return ()
